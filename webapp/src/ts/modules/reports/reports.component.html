<mm-tool-bar title="Reports">
  @if (!selectMode) {
    <mm-search-bar
      (toggleFilter)="toggleFilter()"
      (search)="search()"
      [disabled]="selectMode && selectedReports?.length"
      [showFilter]="true">
    </mm-search-bar>
  }
  @if (selectModeAvailable && selectMode && selectedReports?.length) {
    <mm-multiselect-bar
      [display]="'mobile'"
      [selectedCount]="selectedReports?.length"
      [areAllReportsSelected]="areAllReportsSelected()"
      (deleteItems)="bulkDeleteReports()"
      (selectItems)="selectAllReports()"
      (deselectItems)="deselectAllReports()">
    </mm-multiselect-bar>
  }
  <mm-reports-more-menu (exportReports)="exportReports()"></mm-reports-more-menu>
</mm-tool-bar>

<div class="inner">
  <div class="inbox page">

    <div id="reports-list"
      class="inbox-items left-pane"
      [ngClass]="{ 'col-sm-3': isSidebarFilterOpen, 'col-sm-4': !isSidebarFilterOpen, 'select-mode-available': selectModeAvailable }">

      @if (!loading && selectModeAvailable && reportsList?.length) {
        <div class="select-all">
          <input type="checkbox"
            (click)="areAllReportsSelected() ? deselectAllReports() : selectAllReports()"
            [checked]="areAllReportsSelected()"
            [indeterminate]="areSomeReportsSelected()">
          <span class="select-all-label" (click)="areAllReportsSelected() ? deselectAllReports() : selectAllReports()">
            {{ (areAllReportsSelected() ? 'select.mode.deselect.all' : 'select.mode.select.all') | translate }}
          </span>
        </div>
      }

      <div class="items-container">
        <ul [hidden]="loading && !appending">
          @for (report of reportsList; track listTrackBy($index, report)) {
            <li
              [attr.data-record-id]="report._id"
              [class.selected-to-view] = "selectedReport?.doc?._id === report._id"
              [class.unread]="!report.read"
              (click)="selectReportRow(report)"
              class="content-row">
              <input type="checkbox" (click)="selectReport(report)" [checked]="selectMode && report.selected">
              <a [routerLink]="['/reports', report._id]">
                @if (report.icon) {
                  <div class="icon" [innerHTML]="report.icon | resourceIcon"></div>
                }
                <div class="content">
                  <div class="heading">
                    <h4><span>{{ report.heading }}</span></h4>
                    <div class="date"><span [innerHTML]="report.reported_date | relativeDate"></span></div>
                  </div>
                  @if (report.summary) {
                    <div class="summary">
                      <p>{{ report.summary }}</p>
                      @if ((!report.valid || report.verified !== undefined)) {
                        <div class="status">
                          <span [class.verified]="report.valid && report.verified" [class.error]="!(report.valid && report.verified)" class="verification-badge">
                            @if (report.valid && report.verified) {
                              <report-verify-valid-icon></report-verify-valid-icon>
                            }
                            @if (!(report.valid && report.verified)) {
                              <report-verify-invalid-icon></report-verify-invalid-icon>
                            }
                          </span>
                        </div>
                      }
                    </div>
                  }
                  @if (report.lineage?.length) {
                    <div class="detail" [innerHTML]="report.lineage | lineage"></div>
                  }
                </div>
              </a>
            </li>
          }
        </ul>

        @if (error) {
          <p class="alert alert-danger" role="alert">
            @if (errorSyntax) {
              <span><span>{{ 'invalid.query' | translate }}</span></span>
            }
            @if (!errorSyntax) {
              <span>{{ 'Error fetching reports' | translate }}</span>
            }
          </p>
        }
        @if (!error && !loading && !hasReports) {
          <p class="loading-status">{{ 'reports.none' | translate }}</p>
        }
        @if (!loading && hasReports && !moreItems) {
          <p class="loading-status">{{ 'No more reports' | translate }}</p>
        }
        @if (loading) {
          <div class="loader"></div>
        }
        <div class="padding"></div>
      </div>

      <mm-fast-action-button class="mobile-only"
        [config]="{ button: { type: buttonType.FAB, label: 'report.new_report.button' } }"
        [fastActions]="fastActionList">
      </mm-fast-action-button>

      <mm-fast-action-button class="desktop-only"
        [config]="{ button: { type: buttonType.FLAT, label: 'report.new_report.button' } }"
        [fastActions]="fastActionList">
      </mm-fast-action-button>
    </div>

    <div class="content-pane right-pane">
      <div class="item-content" [ngClass]="{ 'col-sm-6': isSidebarFilterOpen, 'col-sm-8': !isSidebarFilterOpen }">
        @if (selectModeAvailable && selectMode && selectedReports?.length) {
          <mm-multiselect-bar
            [selectedCount]="selectedReports?.length"
            (deleteItems)="bulkDeleteReports()">
          </mm-multiselect-bar>
        }
        <router-outlet></router-outlet>
      </div>

      <mm-reports-sidebar-filter
        class="col-sm-3 sidebar-filter-wrapper"
        (search)="search()"
        [disabled]="selectMode && selectedReports?.length">
      </mm-reports-sidebar-filter>
    </div>
  </div>
</div>
