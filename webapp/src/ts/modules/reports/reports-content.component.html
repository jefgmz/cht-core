<ng-container>
  @if (loadingContent && !selectMode) {
    <div class="empty-selection">
      <div>
        <div class="loader"></div>
      </div>
    </div>
  }

  @if (!loadingContent && !selectedReports?.length) {
    <div class="empty-selection">
      <div>{{'No report selected' | translate }}</div>
    </div>
  }

  @if (selectMode || (!loadingContent && selectedReports?.length && selectedReports[0]?.doc?.form !== undefined)) {
    <div id="reports-content"
      class="report-wrap"
      >
      <mm-fast-action-button [fastActions]="fastActionList"></mm-fast-action-button>
      @for (selection of selectedReports; track trackByFn($index, selection)) {
        <div class="body report-body">
          <div class="item-summary" (click)="toggleExpand(selection)">
            <span class="icon" [innerHTML]="summaries[$index] | formIcon:forms"></span>
            @if (selectMode && !isMobile()) {
              <a class="deselect" (click)="deselect(selection, $event)">
                <i class="fa fa-minus-circle"></i>
              </a>
            }
            <div class="detail">
              @if (summaries[$index]?.subject?.type) {
                <div class="subject">
                  @if (summaries[$index]?.subject._id) {
                    <a class="name"
                      [routerLink]="['/contacts', summaries[$index].subject._id]"
                      [innerHTML]="(summaries[$index].subject.type === 'name' && summaries[$index].subject.value) || summaries[$index].subject.name || ('report.subject.unknown' | translate)">
                    </a>
                  }
                  @if (!summaries[$index]?.subject._id) {
                    <span class="name"
                      [innerHTML]="(summaries[$index]?.subject.type === 'name' && summaries[$index].subject.value) || summaries[$index].subject.name || ('report.subject.unknown' | translate)">
                    </span>
                  }
                </div>
              }
              @if (!summaries[$index]?.subject?.type) {
                <mm-sender [message]="selection" [hideLineage]="true"></mm-sender>
              }
              <div test-id="form-title">
                <span>{{ summaries[$index] | title:forms }}</span>
                @if (!validChecks[$index] || summaries[$index]?.verified !== undefined) {
                  <div class="status">
                    @if (validChecks[$index] && summaries[$index]?.verified) {
                      <span class="verification-badge verified">
                        <report-verify-valid-icon></report-verify-valid-icon>
                      </span>
                    }
                    @if (!(validChecks[$index] && summaries[$index]?.verified)) {
                      <span class="verification-badge error">
                        <report-verify-invalid-icon></report-verify-invalid-icon>
                      </span>
                    }
                  </div>
                }
              </div>
              @if (summaries[$index]?.subject?.lineage || selection.lineage || selection.contact?.parent || selection.place || (!selection.form && selection.name)) {
                <div class="position small-font"
                  [innerHTML]="summaries[$index]?.subject?.lineage || selection.lineage || selection.contact?.parent || selection.place | lineage">
                </div>
              }
              @if (summaries[$index]?.subject?.type) {
                <mm-sender [message]="selection" [hideLineage]="true"
                [sentBy]="true"></mm-sender>
              }
              <div class="time small-font" [innerHTML]="summaries[$index]?.reported_date | relativeDate"></div>
            </div>
          </div>
          @if (selection.loading) {
            <div>
              <div class="loader"></div>
            </div>
          }
          @if (selection.expanded) {
            <div class="details">
              <ul>
                @if (selection.formatted?.form) {
                  @for (field of (selection.formatted.content_type === 'xml' ? selection.formatted.fields : selection.formatted.fields.data); track field) {
                    <li
                      class="indent-{{field.depth || 0}}" [attr.test-id]="field?.label">
                      <label>
                        @if (selection.formatted.content_type === 'xml') {
                          <span [attr.test-id]="'label'">{{field.label | translate}}</span>
                        }
                        @if (selection.formatted.content_type !== 'xml') {
                          <span [attr.test-id]="'label'">{{field.label}}</span>
                        }
                        @if (field.generated) {
                          <span class="fa fa-cogs" title="{{'Generated report field' | translate }}"></span>
                        }
                      </label>
                      @if (!field.imagePath) {
                        <p>
                          @if (field?.target?.filter) {
                            <span [attr.test-id]="field?.label" [class.disabled]="selectMode">
                              <a (click)="search(field.target.filter)">{{field.value}}</a>
                            </span>
                          }
                          @if (field?.target?.url) {
                            <span [attr.test-id]="'value'">
                              <a [routerLink]="field.target.url">{{field.value}}</a>
                            </span>
                          }
                          @if (!field.target) {
                            <span [attr.test-id]="'value'">{{field.value}}</span>
                          }
                        </p>
                      }
                      @if (field.imagePath) {
                        <report-image [report]="selection.formatted?._id" [path]="field.imagePath">
                        </report-image>
                      }
                    </li>
                  }
                }
                @if (selection.formatted?.errors?.length) {
                  <li>
                    <label>{{'Errors' | translate}}</label>
                    <ul>
                      @for (error of selection.formatted.errors; track error) {
                        <li>
                          <p>{{error.message}}</p>
                        </li>
                      }
                    </ul>
                  </li>
                }
                @if (selection?.formatted?.sms_message?.message) {
                  <li>
                    <label>{{'selection.doc.content.raw' | translate}}</label>
                    <p [attr.test-id]="'raw-report-content'">{{selection.formatted.sms_message.message}}</p>
                  </li>
                }
                @if (selection?.formatted?.tasks?.length) {
                  <li>
                    @if (selection.formatted.kujua_message) {
                      <label>{{'tasks.0.messages.0.to' | translate}}</label>
                    }
                    @if (!selection.formatted.kujua_message) {
                      <label>{{'Automated Reply' | translate}}</label>
                    }
                    <ul class="task-list" [attr.test-id]="'automated-reply'">
                      @for (task of selection.formatted.tasks; track task) {
                        <li>
                          <ul>
                            @for (message of task.messages; track message) {
                              <li>
                                <p [attr.test-id]="'message-content'">{{selection.formatted.kujua_message ? message.to : message.message}}</p>
                              </li>
                            }
                          </ul>
                          <span class="task-state" [innerHTML]="task | state | async"></span>
                        </li>
                      }
                      <li class="clear"></li>
                    </ul>
                  </li>
                }
              </ul>
              @if (selection?.formatted?.scheduled_tasks_by_group?.length) {
                <div class="scheduled-tasks">
                  <h2>{{'tasks' | translate}}</h2>
                  <ul>
                    @for (group of selection.formatted.scheduled_tasks_by_group; track group) {
                      <li [attr.test-id]="'tasks'">
                        @if ({ loading: false }; as localContext) {
                          <h3 [attr.test-id]="'task-title'">{{group.name}}</h3>
                          <p>
                            @if (!localContext.loading) {
                              <span>
                                <a class="btn btn-link" (click)="edit(selection, group)">{{'Edit' | translate}}</a>
                                @if (canMute(group)) {
                                  <a class="btn btn-link" (click)="mute(selection, group, localContext)"
                                  >{{'Mute' | translate}}</a>
                                }
                                @if (canSchedule(group)) {
                                  <a class="btn btn-link" (click)="schedule(selection, group, localContext)"
                                  >{{'Schedule' | translate}}</a>
                                }
                              </span>
                            }
                            @if (localContext.loading) {
                              <span class="inline loader"></span>
                            }
                          </p>
                          <ul class="task-list">
                            @for (task of group.rows_sorted; track task) {
                              <li [attr.test-id]="'task-message'">
                                <ul>
                                  @for (message of task?.messages; track message) {
                                    <li>
                                      <p [attr.test-id]="'message-content'">{{message.message}}</p>
                                      @if (message.error) {
                                        <div class="message-error">
                                          <span>{{'messages.errors.invalid' | translate}}</span>
                                          <span>{{message.error | translate}}</span>
                                        </div>
                                      }
                                    </li>
                                  }
                                </ul>
                                <span class="task-state {{ task.error ? 'has-error' : ''}}"
                                [innerHTML]="task | state | async"></span>
                              </li>
                            }
                            <li class="clear"></li>
                          </ul>
                        }
                      </li>
                    }
                  </ul>
                </div>
              }
            </div>
          }
        </div>
      }
      @if (loadingContent && selectMode) {
        <div>
          <div class="loader"></div>
        </div>
      }
      <div class="padding"></div>
    </div>
  }
</ng-container>
